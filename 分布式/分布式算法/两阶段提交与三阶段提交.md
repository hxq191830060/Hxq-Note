两阶段提交和三阶段提交都需要引入2个角色

* **事务协调器**——一个全局事务由多个小事务组成，事务协调器负责和各个小事务进行沟通，指导他们提交or回滚（大哥）
* **事务管理器**——用于管理小事务（小弟）

要提交一个全局事务，必须保证属于该全局事务的所有小事务都应该全部提交，只要有任何一个小事务无法提交，那么整个全局事务就要回滚



## 1. 两阶段提交

### 1.1 阶段一：Prepare

当大哥准备提交全局事务时，会逐个通知各个小弟，如果小弟觉得自己没有问题，就会把事务执行过程中生成的redo log，undo log刷新到磁盘上，然后向大哥返回Yes响应，如果小弟出现了问题，向大哥返回No响应

### 1.2 阶段二：Commit

大哥会收集所有小弟的响应，有以下2种情况

* 如果小弟都返回了Yes响应
  1. 大哥向所有小弟发从Commit请求
  2. 小弟收到Commit请求后，真正提交事务，然后向大哥返回Yes响应
  3. 大哥在收到所有小弟的Yes响应后，完成事务，大哥在某个地方记录下全局事务已提交
* 如果有任何一个小弟返回No响应or有小弟超时未返回请求
  1. 大哥向所有小弟发送Rollback请求
  2. 所有小弟收到RollBack请求后，会通过undo日志回滚，然后向大哥返回Yes响应
  3. 大哥收到所有小弟的Yes响应后，完成事务回滚



### 1.3 两阶段提交缺点

* **同步阻塞**——在两阶段提交执行过程中，参与该全局事务的逻辑都会处于阻塞状态
* **单点问题**——一旦大哥出现问题，那么整个两阶段提交都会无法运转，如果大哥在Commit阶段出现问题，那么会导致小弟一直处于锁定事务资源状态（死锁风险）
* **数据不一致**——在Commit阶段，大哥向所有小弟发送Commit请求，有部分小弟没有收到Commit请求，无法提交事务，导致数据不一致
* **过于保守**——如果在Prepare阶段因为网络，大哥迟迟无法收到小弟的响应，那么大哥只能根据自身的超时机制来判断是否要中断事务，并且两阶段提交没有比较完善的容错机制，任意一个节点的失败都会导致整个全局事务的失败



## 2. 三阶段提交

三阶段提交分为三个阶段——CanCommit**，**PreCommit**，**DoCommit**



### 2.1 阶段一：CanCommit

1. 当大哥准备提交全局事务时，向所有小弟发送CanCommit请求，询问小弟事务可以执行事务的提交操作
2. 小弟收到CanCommit请求后，如果可以，会向大哥返回Yes响应，否则返回No响应

### 2.2 阶段二：PreCommit

大哥收集小弟的响应，有以下两种情况

* 所有小弟都返回了Yes响应
  1. 大哥向所有小弟发送PreCommit请求
  2. 小弟收到PreCommit请求后，将事务执行过程中生成的redo日志，undo日志落盘，如果没有什么问题，就会向大哥返回Yes响应，如果出现了问题，向大哥返回No响应
* 有任意一个小弟返回了No响应or有小弟超时未返回响应
  1. 大哥向所有小弟发送abort请求
  2. 小弟收到abort请求or小弟超时未收到大哥消息——中断事务

### 2.3 阶段三：DoCommit

大哥收集小的的响应，有以下两种情况

* 所有小弟都返回了Yes响应
  1. 大哥向所有小弟发送DoCommit请求
  2. 小弟收到DoCommit请求后，真正的提交事务，向大哥返回Yes响应
  3. 大哥收到所有小弟的Yes响应后，完成事务，大哥在某个地方记录下全局事务已提交
* 有小弟返回No响应or有小弟超时未返回响应
  1. 大哥向所有小弟发送abort请求
  2. 小弟收到abort请求后，利用undo日志回滚，回滚成功后，向大哥返回Yes响应
  3. 大哥收到所有小弟的Yes响应后，中断事务