#  1. CAP理论

一个分布式系统不可能同时满足**一致性**，**可用性**，**分区容错性**，最多只能**同时满足其中的两项**

* **一致性C**

  客户端的每次读操作，不管访问哪个节点，要么读到的都是同一份最新的数据，要么读取失败（强调的是各节点之间的数据一致，而不是数据完整）

* **可用性A**

  系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能够**在有限的时间**内返回结果，但不保证每个节点都能返回最新的数据

* **分区容错性P**

  节点间出现任意数量的消息丢失or高延迟or分区故障的时候，系统仍然可以继续提供服务，强调的是集群对分区故障的容错能力



## CAP理论的使用

* **P是必须满足的**——因为只要是网络交互就一定有延迟和消息丢失
* **当分布式系统发生分区故障时**，我们需要P，此时需要在A和C之间做出选择
  * **选择C**——当发生分区故障时，消息丢失，此时无法保证所有节点的数据都是最新的，那么这个时候，集群就要拒绝所有Client的写请求
  * **选择A**——当发生分区故障时，集群始终会处理客户端的请求，但是访问不同的节点可能得到不同的数据



## CAP理论的具体应用

* CA模型——舍弃P就是舍弃分布式系统，比如单机版的MySQL
* CP模型——一旦消息丢失，高延迟，分区故障，那么会影响用户体验和业务的可用性（Zookeeper，Etcd，HBase）
* AP模型——实现服务的高可用，当出现分区故障时，访问不同的节点可能会得到不同的数据（Cassandra，DynamoDB）



## AP和CP的实现

* CP——Raft或者ZAB
* AP——Quorum NWR，Gossip



# 2. ACID理论

* ACID理论是CAP理论中CP的延伸，**ACID追求强一致性模型，是最强的一致性**

* **分布式系统要实现ACID**——依靠**分布式事务协议**
  * 2PC
  
  * 3PC

  * TCC
  
  * 基于消息补偿的最终一致性
  



# 3. BASE理论

* **BASE理论是CAP理论中AP的延伸，强调高可用性**

* BASE是A和C权衡的结果，通过牺牲强一致性获得基本可用性——在NoSQL，微服务架构中应用广泛

* Basically Available(基本可用)，Soft state(软状态)，Eventually consistent(最终一致性)

* **基本可用**

  分布式系统出现故障时，允许损失部分可用性，保障核心功能的可用性（例如通过服务降级，流量削峰，延迟响应，过载保护）

* **软状态**

  存在软状态——业务操作没有最终完成前的中间状态

  > 例如：整个业务流程是：顾客下单—创建订单—发送短信
  >
  > 创建订单后我们就告诉顾客操作成功，但此时业务操作还没有最终完成，这就是软状态

* **最终一致性**

  系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态（不需要实时保证系统数据的强一致性）






## 3.1 最终一致性实现方法

* 读时修复：在读取数据时，检查数据的不一致情况，进行修复（查询时，检测不同节点的副本数据是否一致）
* 写时修复：在写入数据时，检查数据的不一致情况，进行修复（节点之间进行写操作同步时，如果失败了，就将写操作缓存下来，定时重传）——对考虑性能的情况下，用户写操作只需要对一个实例写，该实例会负责将这个写操作同步给其他实例，建议优先考虑
* 异步修复：定时对不同副本的数据进行校对，如果不一致就修复