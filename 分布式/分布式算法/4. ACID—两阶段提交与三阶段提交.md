两阶段提交和三阶段提交都需要引入2个角色

* **事务协调器**——一个全局事务由多个小事务组成，事务协调器负责和各个小事务进行沟通，指导他们提交or回滚（大哥）
* **事务管理器**——用于管理小事务（小弟）

要提交一个全局事务，必须保证属于该全局事务的所有小事务都应该全部提交，只要有任何一个小事务无法提交，那么整个全局事务就要回滚



## 1. 两阶段提交

### 1.1 阶段一：Prepare

当大哥准备提交全局事务时，会逐个通知各个小弟，如果小弟觉得自己没有问题，就会把事务执行过程中生成的redo log，undo log刷新到磁盘上，然后向大哥返回Yes响应，如果小弟出现了问题，向大哥返回No响应

### 1.2 阶段二：Commit

大哥会收集所有小弟的响应，有以下2种情况

* 如果小弟都返回了Yes响应
  1. 大哥向所有小弟发从Commit请求
  2. 小弟收到Commit请求后，真正提交事务，然后向大哥返回Yes响应
  3. 大哥在收到所有小弟的Yes响应后，完成事务，大哥在某个地方记录下全局事务已提交
* 如果有任何一个小弟返回No响应or有小弟超时未返回请求**（大哥的超时机制）**
  1. 大哥向所有小弟发送Rollback请求
  2. 所有小弟收到RollBack请求后，会通过undo日志回滚，然后向大哥返回Yes响应
  3. 大哥收到所有小弟的Yes响应后，完成事务回滚



### 1.3 两阶段提交缺点

* **同步阻塞**——参与者在等待协调者的指令时，是无法进行其他操作的，如果参与者和协调者之间由于网络问题一直无法通信，那么参与者会一直阻塞下去
* **协调者单点问题**——如果大哥在Commit阶段出现问题，小弟无法Commit or Rollback，小弟一直处于锁定事务资源状态（有死锁风险）
* **过于保守**——如果在Prepare阶段因为网络，大哥迟迟无法收到小弟的响应，那么大哥只能根据自身的超时机制来判断是否要中断事务，并且两阶段提交没有比较完善的容错机制，任意一个节点的失败都会导致整个全局事务的失败
* **数据一致性问题**——在Commit阶段，如果因为网络问题，一部分参与者没有收到消息，一部分参与者收到了消息，那么会导致参与者之间的数据不一致问题



## 2. 三阶段提交

* 三阶段提交分为三个阶段——CanCommit**，**PreCommit**，**DoCommit
* **优点**
  * 减少了同步阻塞——CanCommit阶段时不阻塞的，并且参与者也有了超时机制，如果参与者迟迟没有收到协调者的下一个指令，会自动abort或者提交事务，降低了阻塞
  * 2PC只有协调者有超时机制，3PC为参与者引入超时机制，解决了2PC的单点问题（但同时也引入了数据一致性问题）
* **缺点**
  * 未能完全解决同步阻塞问题
  * 仍存在数据一致性问题——在DoCommit阶段，如果大哥与小弟无法通信，那么小弟超时后会自动提交事务，这就可能造成数据一致性问题

### 2.1 阶段一：CanCommit

1. 当大哥准备提交全局事务时，向所有小弟发送CanCommit请求，询问小弟事务可以执行事务的提交操作
2. 小弟收到CanCommit请求后，如果可以，会向大哥返回Yes响应，否则返回No响应

### 2.2 阶段二：PreCommit

大哥收集小弟的响应，有以下两种情况

* 所有小弟都返回了Yes响应
  1. 大哥向所有小弟发送PreCommit请求
  2. 小弟收到PreCommit请求后，将事务执行过程中生成的redo日志，undo日志落盘，如果没有什么问题，就会向大哥返回Yes响应，如果出现了问题，向大哥返回No响应
* 有任意一个小弟返回了No响应or有小弟超时未返回响应**（协调者的超时机制）**
  1. 大哥向所有小弟发送abort请求
  2. 小弟收到abort请求——中断事务

### 2.3 阶段三：DoCommit

大哥收集参与者的的响应，有以下两种情况

* 所有小弟都返回了Yes响应
  1. 大哥向所有小弟发送DoCommit请求
  2. 小弟收到DoCommit请求后，真正的提交事务，向大哥返回Yes响应
  3. 大哥收到所有小弟的Yes响应后，完成事务，大哥在某个地方记录下全局事务已提交
* 有小弟返回No响应or有小弟超时未返回响应**（协调者的超时机制）**
  1. 大哥向所有小弟发送abort请求
  2. 小弟收到abort请求后，利用undo日志回滚，回滚成功后，向大哥返回Yes响应
  3. 大哥收到所有小弟的Yes响应后，中断事务

### 2.4 3PC中参与者的超时机制

* 参与者收到PreCommit请求后，开始等待DoCommit请求，如果迟迟接收不到协调者的DoCommit请求，超时后，参与者会自动提交事务，释放资源

* 参与者收到CanCommit请求后，开始等待PreCommit请求，如果迟迟接收不到协调者的PreCommit请求，超时后，参与者会自动回滚释放，释放资源







