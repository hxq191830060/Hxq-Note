

# 1. 分布式的特点

* 分布性

  分布式系统的多台计算机在空间上随意分布

* 对等性

  组成分布式系统的所有计算机节点都是对等的

  **副本**的概念

  * 数据副本

    不同的节点持久化同一份数据，当某一个节点上存储的数据丢失时，可以从副本上读取到该数据

  * 服务副本

    多个节点提供同样的服务，每个节点都有能力接收外部的请求并进行相应的处理

* 并发性

  分布式系统中的一些节点可能会并发地操作一些共享的资源

* 缺乏全局时钟

* 故障总是会发生的







# 2. 分布式环境的各种问题

* 通信异常

  消息丢失和消息延迟非常普遍

* 网络分区

  网络发生异常情况，导致分布式系统中部分节点之间的网络延时不断增大，最终导致组成分布式系统的所有节点中，只有部分节点之间能够进行正常通信，而另一些节点则不能——这个现象就是网络分区，俗称“脑裂”



# 3. 分布式理论



##  3.1 CAP

一个分布式系统不可能同时满足**一致性**，**可用性**，**分区容错性**，最多只能**同时满足其中的两项**

分区容错性是分布式系统最基本的要求，一般在一致性和可用性之间寻求平衡

* **一致性C**

  数据在多个副本之间保持一致

  * **强一致性**

    在分布式系统中，如果能够对一个数据项的更新操作执行成功后，所有的用户都可以读取到其最新的值，那么该分布式系统就被认为具有强一致性

  * **弱一致性**

    约束了系统在写入成功后，不承诺立即可以读到写入的值，也不承诺多久之后数据能够达到一致，但会尽可能地保证到某个时间级别（比如秒级别）后，数据能够达到一致状态

  * **最终一致性**

    系统会保证在一定时间内，能够达到一个数据一致的状态（大型分布式系统比较推崇的模型）

* **可用性A**

  系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能够**在有限的时间**内返回结果

* **分区容错性P**

  分布式系统在遇到任何网络分区故障的时候，仍然能够保持对外提供满足一致性和可用性的服务，除非是整个网络环境都发生了故障
  
  （网络分区是指不同的节点分布在不同的子网络，子网络之间网络不连通，但是子网络内部网络是正常的）



**P是分布式系统一定要满足的，我们一般在AP和CP之间进行选择，也就是说一致性和可用性二选一or在二者之间寻求平衡**

* **CP**——保证数据的强一致性，但是用户体验比较差
* **AP**——用户体验比较好

>* **ACID**：若分布式系统采用ACID原则，那么会丧失一定的可用性，属于CP系统
>* **BASE**：用最终一致性来换取可用性，属于AP系统



## 3.2 BASE理论

BASE是AP理论的延伸

Basically Available(基本可用)，Soft state(软状态)，Eventually consistent(最终一致性)

* **核心思想**

  即使无法做到强一致性，但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性

* **基本可用**

  分布式系统出现故障时，允许损失部分可用性

  >例如：整个业务流程是：顾客下单—创建订单—发送短信
  >
  >创建订单后我们就告诉顾客操作成功，短信发送是否成功就无关紧要
  
* **软状态**

  存在软状态——业务操作没有最终完成前的中间状态

  > 例如：整个业务流程是：顾客下单—创建订单—发送短信
  >
  > 创建订单后我们就告诉顾客操作成功，但此时业务操作还没有最终完成，这就是软状态

* **最终一致性**

  系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态（不需要实时保证系统数据的强一致性）





## 3.3 达到最终一致性的方法

### 3.3.1 重试

> 例如：整个业务流程是：顾客下单—创建订单—发送短信
>
> 创建订单后我们就告诉顾客操作成功，然后订单系统将信息存储到MQ中，短信系统订阅MQ获得该消息
>
> 短信系统如果失败了，会不断从MQ中重新获得消息，不断的重试



### 3.3.2 数据校对程序

定时任务每隔一段时间进行数据校对，如果发现不一致的数据——进行补发

>定时任务每隔5分钟访问一次订单系统，抽取订单，对于每一个订单，在短信系统中查看是否存在相匹配的记录，如果没有，就补发短信



