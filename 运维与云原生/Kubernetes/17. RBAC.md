* RBAC（Role-Based Access Controller）基于角色的访问控制——要使用RBAC，需要在Api-Server的启动参数中加上--authorization-mode=RBAC



* RBAC引入4个资源——Role，ClusterRole，RoleBinding，ClusterRoleBinding



## 1. Role

* Role是一组权限的集合，Role是**namespace级别**的，只能对命名空间内的资源进行授权

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: ns
  name: reader
rules:
  - apiGroups: [""]  #支持的API组列表，""表示核心API组，例如:ApiVersion: batch/v1, ApiVersion: extension:v1, ApiVersion:apps/v1等
    resources: ["pods"] #Role可以操作的资源,有pods,jobs,deployments等
    verbs: ["get","watch","list"] #Role可以对资源进行的操作,例如get,watch,list,delete,replace等
```

* 资源还可以通过resourceNames进行引用（只能对指定名字的资源进行操作）

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: ns
  name: xxx
rules:
- apiGroups: [""]
  resources: ["configmap"]
  resourceNames: ["my-config"]
  verbs: ["update","get"]
#只能对名为my-config的configmap资源进行update和get
```



## 2. ClusterRole

* 跟Role一样的作用，不同的是ClusterRole是集群级别的
* ClusterRole还可以赋予集群中特殊元素的权限
  * 集群级别资源——Node
  * 非资源型的路径——/health

```yml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: reader #不需要namespace
rules:
  - apiGroups: []
    resources: []
    verbs: []
```



## 3. RoleBinding和ClusterRoleBinding

* RoleBinding和ClusterRoleBinding用于将一个角色绑定到一个目标上，绑定目标可以是User，Group，Service Account（RoleBinding是namespace级别，ClusterRoleBinding是cluster级别）
* RoleBinding也可以使用ClusterRole

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-pods
  namespace: ns
subjects:
  - kind: User #将角色绑定给用户
    name: hxq
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: hxq
  apiGroup: rbac.authorization.k8s.io
```

```yml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-secrets
  namespace: ns
subjects:
- kind: User
  name: hxq
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: reader
  apiGroup: rbac.authorization.k8s.io
```

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: read-secrets-global
subjects:
- kind: Group
  name: manager
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: reader
  apiGroup: rbac.authorization.k8s.io
```



## 4. 常见Role示例

* 允许读取核心API组中的Pod

```yaml
rules:
- apiGroup: [""]
  resources: ["pods"]
  verbs: ["get","list","watch"]
```

* 允许读写extensions和apps两个API组中的deployment资源

```yaml
rules:
- apiGroup: ["extensions","apps"]
  resources: ["deployments"]
  verbs: ["get","list","watch","create","update","patch","delete"]
```

* 允许读取核心组的node资源

```yaml
rules:
- apiGroup: [""]
  resources: ["nodes"]
  verbs: ["get","list","watch"]
```

* 允许对非资源端点/health以及其所有子路径进行GET/POST操作

```yaml
rules:
- nonResourceURLS: ["/health","/health/*"]
  verbs: [""]
```

