![7](../0.picture/10.png)

* **管理服务和工具组件**：系统管理和控制工具，例如备份恢复，MySQL复制，集群
* **连接池**：缓存连接
* **SQL接口**：接收用户的SQL，并且返回查询需要的结果
* **缓存**：内存上的query cache，服务层使用的缓存
* **解析器**：解析和验证SQL，生成一棵解析树
* **优化器**：优化解析树



* **查询过程**

1. 服务器使用连接池中的连接与客户端建立连接

2. 服务器通过SQL接口获取客户端的SQL命令

3. 若query cache未开启，进行4

   若query cache开启，服务器查询内存上的query cache，命中则直接通过SQL接口返回结果，未命中——进行4

4. SQL语句经过解析器，生成一棵解析树，然后解析树经过优化器优化

5. 将优化后的解析树，调用存储引擎提供的接口，由存储引擎去执行查询

   

6. **存储引擎层面的操作（设计到内存，日志，索引，锁，很重要）**

   ①InnoDB查看LRU列表，是否有查询数据对应的数据页

   * 如果有，从LRU列表直接读取。

   * 如果没有，从磁盘读取对应的页A**（涉及锁，索引）**，查看Free列表是否有可用页
     * 如果有，那么从Free列表中移除一个可用页，分配给页A，然后放入LRU列表
     * 如果没有，淘汰LRU列表末尾的页，将该页分配给A

   ②同时，InnoBD将此次查询写入查询日志，

   并且InnoDB会根据查询的时间，决定是否将此次查询写入慢查询日志

   

7. 从存储引擎取得查询结果，通过SQL接口向客户端返回结果；

   若开启了缓存，将（SQL的hash值-查询结果）存入query cache

