# 6. Redis持久化

## 6.1 RDB(Redis DataBase)

![RDB](D:\桌面\Notes\Notes\数据库\Redis\p\RDB.png)

在指定的时间间隔内将**内存中的数据**写入磁盘(快照文件)，恢复时将快照文件直接读到内存中

Redis会单独创建(fork)一个子进程来进行持久化，会将内存数据先写入一个临时文件中，再用这个临时文件替换上次持久化好的文件，整个过程，主进程不进行任何IO操作，确保了极高的性能

**RDB文件**：RDB保存的默认文件默认是**dump.rdb**



### RDB触发机制

* save规则满足情况下
* 执行flushall
* 退出redis

### RDB恢复

* Redis启动时，会在 **配置文件配置的dir目录**下检查rdb文件，自动读取恢复

### RDB优缺点

* **优点**
  * 适合大规模的数据恢复
  * 对数据的完整性要求不高
* **缺点**
  * 需要一定的时间，如果Redis意外宕机，最后一次修改数据就没有了
  * fork进程的时，会占用一定的内存

## 6.2 AOF(Append Only File)

以日志的形式记录每个写操作，只许追加文件，不可以改写文件

恢复时，根据该文件的内容将指令执行一遍恢复

**AOF默认不开启，需要手动开启**

如果恶意修改aof文件，那么Redis无法启动，不过可以使用Redis提供的工具redis-check-aof来修复

### 优点和缺点

* 缺点
  * aof远远大于rdb文件，修复速度也比rdb慢
  * aof运行效率比rdb慢



## 6.3 拓展

1. RDB持久化方式能够在指定的时间间隔内对你的数据进行快照存储

2. AOF持久化方式记录每次写操作，当服务器重启时，重新执行这些操作来恢复原始数据，AOF以Redis协议追加保存每次写操作到文件末尾，Redis还能对AOF文件进行后台重写，使得AOF文件的体积不至于过大

3. Redis只做缓存，如果你只希望你的数据在服务器运行时存在，你也可以不使用任何持久化

4. 同时开启两种持久化方式

   * 在这种情况下，在Redis重启时，会优先载入AOF来恢复数据，因为同通常情况下，AOF文件保存的数据集比RDB要完整
   * RDB的数据不实时，同时使用两者时服务器也只会找AOF文件，那要不要使用AOF呢？作者建议不要，因为RDB更适合用于备份数据库，快速重启，而且不会有AOF可能潜在的bug

5. 性能建议

   * 因为RDB文件只用作后背用途，建议只在slave上持久化RDB文件，而且只需要15分钟备份一次就足够了

   * 如果Enable AOF，好处是在最恶劣情况下也只会丢失不超过2s数据，启动脚本较简单，只需要load自己的AOF文件就可以。

     代价：一是带来了持续的IO，二是AOF rewrite的最后将rewrite过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的，只要硬盘许可，应该尽量减少AOF rewrite的频率，AOF重写的基础大小默认是64M太小，可以设到5G以上

   * 如果不Enable AOF，仅靠主从架构实现高可用性也可以，能省掉一大笔IO，也较少了rewrite时带来的系统波动

     代价是如果master和slave同时宕机，会丢失10几分钟的数据，启动脚本也要比较master和slave的RDB文件，载入较新的那个