[TOC]



### 2PC和3PC

#### 1. 基础思想

在分布式事务中，参与分布式事务的节点称为**参与者**，每个参与者可以知道自己成功与否，但无法直接获取其他参与者的执行结果

所以，我们需要一个**协调者**——统一调度所有参与者的执行逻辑，并最终决定是否提交事务



#### 2. 2PC

* **2PC协议说明**

  2PC——两阶段提交，分为**两个阶段**——**分发事务请求**+**执行事务提交**

  在数据库领域内，为了使分布式系统架构下的所有节点在进行事务处理中能保持**原子性**和**一致性**而设计的算法

  大部分**关系型数据库**使用**二阶段提交协议**来完成分布式事务处理

* **协议内容**

  * **阶段一：分发事务请求**

    1. 协调者向所有参与者分发事务请求，各个参与者执行事务操作，并更新自己的undo log和redo log
    2. 参与者如果成功执行事务，向协调者返回Yes响应，否则返回No响应

  * **阶段二：执行事务提交**

    协调者收集所有参与者的响应，有以下两种情况

    * **如果都是Yes响应**——**执行事务提交**

      1. 协调者向所有参与者发送**Commit请求**

      2. 各个参与者收到Commit请求后，提交事务

      3. 各个参与者提交事务后，向协调者发送Ack响应

      4. 协调者收到所有参与者的Ack响应后，完成事务提交

         ![1](../\p\11.png)

    * **任何一个参与者反馈No响应或者没响应**——**回滚事务**

      1. 协调者向所有参与者发送**Rollback请求**

      2. 各个参与者收到Rollback请求后，利用undo log进行事务回滚

      3. 各个参与者回滚事务后，向协调者发送Ack响应

      4. 协调者收到所有参与者的Ack响应后，完成回滚事务

         ![2](../p\12.png)

* **2PC缺点**

  * **同步阻塞**

    在第二阶段，所有的参与者都处于阻塞状态

  * **单点问题**

    如果协调者出现问题，那么第二阶段就无法运转，所有参与者都会处于锁定事务资源状态

  * **数据不一致**

    在第二阶段，当协调者向所有参与者开始发出Commit请求之后，发送完Commit请求之前，如果出现网络异常或者协调者崩溃，就会导致部分参与者收到Commit请求，进行事务提交，部分参与者没有收到，无法进行事务提交

  * **过于保守**

    没有完善的容错机制，任意一个节点的失败都会导致整个事务的失败

    

#### 3. 3PC

* **3PC说明**

  3PC——三阶段提交，分为三个阶段——**CanCommit，PreCommit，DoCommit**

* **协议内容**

  * **阶段一：CanCommit**

    1. 协调者向所有参与者发送**canCommit请求**，询问参与者是否可以执行事务操作
    2. 参与者收到**canCommit请求**后，如果认为自己可以顺利执行事务，返回Yes响应，否则返回No响应

  * **阶段二：PreCommit**

    协调者收集响应，有以下两种情况

    * **所有参与者都是Yes响应——执行事务**

      1. 协调者向所有参与者发送**PreCommit请求**

      2. 参与者收到**PreCommit请求**后，执行事务操作，并更新redo log和undo log

      3. 若参与者成功执行事务操作，返回Ack响应，并等待最终请求（DoCommit或Abort）

         **若参与者等待最终请求超时——提交事务**

    * **有任何一个参与者是No响应或者没有响应——中断事务**

      1. 协调者向所有参与者发送**abort请求**
      2. 参与者收到**abort请求**或者**等待超时**——中断事务

  * **阶段三：DoCommit**

    协调者收集所有参与者的Ack响应，有两种情况

    * **成功收集到所有参与者的Ack——执行提交**
      1. 协调者向所有参与者发送**DoCommit请求**
      2. 参与者收到**DoCommit请求**后，提交事务，向协调者发送Ack消息
      3. 协调者收到所有参与者的Ack，完成事务
    * **协调者无法接收到所有参与者的Ack响应——中断事务**
      1. 协调者向所有参与者发送**abort请求**
      2. 参与者接收到**abort请求**后，利用undo log回滚，回滚成功后，向协调者发送Ack消息
      3. 协调者收到所有参与者的Ack后，中端事务

* **缺陷**

  参与者在第二阶段，接收到PreCommit请求后，会执行事务操作，然后等待最终请求

  如果此时网络异常或者协调者崩溃，导致参与者等待超时，参与者会**自动提交事务**，这就会导致**数据不一致**



### Paxos

暂时不会
