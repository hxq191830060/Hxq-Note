[toc]





## Zookeeper的ZAB协议——两个模式

Zookeeper依赖ZAB协议实现 **分布式数据一致性**，ZAB实现了2个模式——消息广播模式，崩溃恢复模式，Zookeeper集群要么处于消息广播模式，要么处于崩溃恢复模式



### 1. 消息广播模式

#### 1.1 处于消息广播模式的时机

集群中有过半的Follower与Leader同步——正常工作，处于消息广播模式

#### 1.2 消息广播模式工作工程

* **前提**：Zookeeper只允许唯一的Leader服务器进行事务请求的处理，余下的服务器成为Follower服务器

* **服务器加入集群**：一台遵守ZAB的新服务器加入集群后发现集群存在Leader负责消息广播，就会自觉地开始同步Leader的数据

* ①所有的客户端**事务请求**都会转发给Leader，由Leader为**事务请求**生成为一个Proposal

* ②Leader为每个Proposal分配一个事务ID**(每一个事务Proposal按照其ZXID的先后顺序来进行排序和处理)**

* ③Leader在Leader内部为每个Follower分配一个单独的队列，然后将Proposal依次放入这些队列中，然后根据FIFO的策略进行消息发送

* ④每个Follower收到Proposal后，首先写入磁盘上的**事务日志**，然后执行操作，操作成功后，返回给Leader一个Ack响应

* ⑤Leader接收到过半Follower的Ack响应后，就会向所有的Follower分发Commit消息，要求对前一个Proposal进行提交，同时Leader自身完成对事务的提交，每个Follower接收到Commit消息后，完成对事务的提交

#### 1.3 消息广播模式的问题——崩溃恢复模式解决

* Leader发起一个Proposal后，收到半数Ack后宕机了，Leader自己Commit了，但还未向Follower发送Commit，这时宕机了——**崩溃恢复机制要保证这个Proposal在崩溃机制后能够被所有的Server Commit**

* Leader发起一个Proposal后宕机了，其他Follower没有收到——**崩溃恢复机制要保证当旧Leader恢复后再次加入集群时，丢弃掉这个Proposal**



### 2. 崩溃恢复模式

#### 2.1 处于崩溃恢复模式的时机

1. Zookeeper在启动过程中，Leader还未选举出来
2. Leader服务器崩溃退出或重启，Leader服务器与半数以上Follower断开连接

#### 2.2 退出崩溃恢复模式的时机

* 通过选举算法选举出新Leader，并且已有过半的服务器与Leader完成**数据同步**

#### 2.3 崩溃恢复模式如何解决消息广播模式的问题

消息广播模式的2个问题，ZAB要求崩溃恢复模式给予了以下保证

* **确保已经在Leader上提交的Proposal最终被所有服务器提交**

  Leader发起一个Proposal后，收到半数Ack后宕机了，Leader自己Commit了，但还未向Follower发送Commit，这时宕机了

  选举出来的新Leader要保证该Proposal在所有的服务器上都成功提交

* **丢弃只在Leader上提出的Proposal**

  Leader发起一个Proposal后宕机了，其他Follower没有收到，要保证当旧Leader恢复后再次加入集群时，丢弃掉这个Proposal

* **崩溃恢复模式通过选举算法解决了这两个问题**

  * 选举算法选举出的新Leader一定是所有机器中**ZXID最大的**——可以保证新选举的Leader一定具有所有已提交的Proposal
  * 新选举的Leader不能含有上一个Leader周期中未提交的Proposal

#### 2.4 崩溃恢复模式的工作过程——Leader选举，数据同步

* **①Leader选举**

  **进行Leader选举，通过选举算法，选举出新的Leader**

* **②数据同步**

  1. 新Leader确认事务日志中所有的Proposal是否已经被集群过半的服务器Commit——数据同步完成的标志

  2. Leader服务器需要确保所有的Follower能收到每一个事务的Proposal，并且能将所有已经提交的Proposal应用到内存数据中。

     Leader会为每一个Follower准备一个队列，将那些没有被各Follower同步的事务以Proposal消息的形式逐个发给各个Follower，并在每一个Proposal消息后紧跟一个Commit消息，以表示该Proposal已被提交

     等到Follower将所有尚未同步的Proposal都从Leader上同步过，并应用到内存数据中心以后，Leader才会把Follower加到可用的Follower列表中
  
* **崩溃恢复模式选举出新Leader，新Leader如何处理要被丢弃的Proposal**

  每个Proposal都有一个ZXID，ZXID64位

  前32位——epoch，标识Leader，每选出一名Leader，epoch+1

  后32位——标识Proposal，每产生一个新的Proposal，后32位+1

  如果一个服务器，包含上一个Leader周期中尚未提交的Proposal，那么该服务器无法成为Leader，当该服务器连上Leader时，Leader会要求该Follower进行回退操作，回退到一个已经被过半机器提交的Proposal