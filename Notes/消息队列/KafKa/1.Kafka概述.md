### 数据存储方式

**Event**

KafKa的数据单元——event

event结构——键，值，时间戳

* event key
* event value
* event timestamp

发布者向KafKa写入Event，订阅者订阅KafKa，从KafKa中取得Event

在KafKa中，发布者和订阅者完全解耦



### **主题和分区**

**Topic**——发布event的地方，可以用来区分业务系统

* **topic为多订阅者模式**——一个topic可以有多个发布者，多个订阅者

* **topic结构**

  * 一个topic由多个分区组成，通过分区实现数据冗余和伸缩性—**分区可以分布在不同的服务器上，所有一个topic可以横跨多个服务器(broker)**

  * 一个分区就是一个提交日志，event以追加的方式写入分区，并且**每个event在分区中都有一个偏移量**

  * **event被订阅者读取后不会删除——一个Event可以被多个订阅者读取**

    **KafKa设置了超时时间，会自动删除旧event**

    **或者保留的event到达了一定的字节数，会删除旧event**

    ![1](p\1.png)

  * **KafKa无法在整个topic的范围内保证订阅者按照消息生成的顺序读取，但是可以保证在单个分区上订阅者按照消息生成的顺序读取**

* **发布者**

  发布者创建event，将其发布到topic中，有以下两种方式

  * 均衡地分布到topic的某一个分区上
  * 使用key和分区器——分区器为key生成一个hash值，然后映射到某个分区上（可以保证key相同的event处于同一个分区）

  **Event是分批次写入KafKa的**——属于同一个topic，同一个分区的event会一起写入KafKa

  **Event写入分区后都会分配一个偏移量**

* **订阅者**

  订阅者读取Event

  订阅者通过检查Event的**偏移量**来区分该Event是否读过

  每个Event在分区中都有一个**唯一的偏移量**

  订阅者会把自己最后读取的Event的偏移量存储在Zookeeper或KafKa上，这样即使订阅者关闭，其读取状态也不会丢失

* **订阅者群组**

  订阅者有两种方式

  * **订阅主题**——订阅者加入一个订阅者群组

    **同一个订阅者群组中的两个订阅者不能读取同一个分区**——但是订阅者群组之间互不影响

    **订阅者群组的好处**

    * 如果一个订阅者失效了，群组中的其他订阅者可以接管失效订阅者的工作
    * 保证了一个Event只会被读取一次
    * 保证订阅者群组中订阅者的数目<=分区数，不然会有订阅者无所事事

    ![1](p\2.png)

  * **独立订阅者**

    不需要订阅主题，而是为自己分配分区

  

  

  ### **KafKa集群**

  * KafKa是一个分布式系统，由多台服务器组成，通过TCP通信

  * **服务器**

    KafKa作为一个服务器集群运行

    * 一些服务器通过KafKa Connect与其他系统（数据库，其他KafKa集群）集成（KafKa Connect可以从其他系统import，export event stream）**（不一定有）**

    * 一些服务器组成存储层——**broker（一定有）**

      * broker接受发布者的event，**为event设置偏移量**，并提交event到磁盘保存

      * broker为消费者提供服务，对读取分区的请求做出响应，返回提交到磁盘上的event

      * 如果分区A从属于一个broker，那么该broker成为分区A的首领

        一个分区从属于一个broker，但是可以将该分区复制给其他的broker——为机制为分区提供**消息冗余**——如果分区的首领失效，那么其他的broker可以成为该分区的新首领，并且相关的发布者和订阅者重新连接到新的首领

        ![1](p\3.png)

    * **集群控制器**

      每个集群都会选举一个broker充当集群控制器——把分区分配给brokers，监控brokers

  

  

  ### KafKa的优点

  * 一个topic支持多个发布者

  * 一个topic支持多个订阅者

    * 多个订阅者可以读取同一个event
    * 多个订阅者可以选择组成订阅者群，保证每个Event只会被读取一次

  * 磁盘存储+非实时读取

    KafKa将发布者发布的Event放入一个分区中，加上偏移量，提交到磁盘上

    订阅者可以进行非实时读取

  * 伸缩性

    一些broker失效，其他的broker可以接管失效的broker的工作，继续提供服务

  

  

  

