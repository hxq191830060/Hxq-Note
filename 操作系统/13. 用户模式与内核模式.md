

# 2. 用户模式与内核模式

一个进程必须能够执行一些受限制的操作（例如IO），但又不能让进程完全控制系统

## 2.1 执行模型

* 用户模式：应用程序不能访问全部的硬件资源
* 内核模式：可以访问机器的全部资源，包括特权操作（发出IO请求，执行所有类型的受限指令）



## 2.2 系统调用

OS通过**系统调用**向应用程序暴露某些关键能力（访问文件系统，创建和销毁进程，分配更多内存等）

应用程序可以通过**系统调用**，从用户模式切换为内核模式，然后执行受限制的操作，执行完后，切换回用户模式



## 2.3 模式切换

提供**trap**和**return-from-trap**指令来进行模式转换

### 2.3.1 执行trap

1. 硬件必须保证能够存储进程的寄存器中的值（保存进程的上下文信息），以便在执行return-from-trap指令时，可以通过保存的寄存器的值（保存的上下文）恢复到用户模式

2. 切换为内核模式

3. 跳转到**trap处理程序**，会将对应的系统调用号（中断号的一种）传递给trap处理程序

### 2.3.2 trap处理程序

trap处理程序根据中断号，从trap table中找到对应的处理程序的地址，执行处理程序

### 2.3.3 执行return-from-trap

1. 通过保存的寄存器的值来恢复进程的寄存器

2. 切换回用户模式

3. 跳转到程序计数器记录的地址

```
在x86上，程序执行trap时，程序计数器等寄存器中的值会push到进程的内核栈中
在执行return-from-trap时，会从栈中弹出这些值来恢复回用户模式
```



## 2.4 trap table

OS启动的时候，会初始化trap table

trap table存储的是**中断号**与**中断处理程序**的地址

* 系统调用属于软件中断
* **中断处理程序**
  * **系统调用处理程序**
  * **时钟处理程序**



## 2.5 程序执行系统调用过程总结

|                       内核                       |                          硬件                          |     应用程序     |
| :----------------------------------------------: | :----------------------------------------------------: | :--------------: |
|                                                  |                                                        |   调用系统调用   |
|                                                  |                                                        | 通过trap陷入内核 |
|                                                  |       保存寄存器的值（x86保存到进程的内核栈中）        |                  |
|                                                  |                     切换为内核模式                     |                  |
|                                                  |          跳转到trap处理程序，并传递系统调用号          |                  |
| trap处理程序根据中断号找到对应中断处理程序的地址 |                                                        |                  |
|     执行中断处理程序（执行系统调用处理程序）     |                                                        |                  |
|             通过return-from-trap返回             |                                                        |                  |
|                                                  | 通过保存的寄存器的值恢复寄存器（从内核栈中恢复寄存器） |                  |
|                                                  |                     切换回用户模式                     |                  |
|                                                  |               跳转到程序计数器记录的地址               |                  |
|                                                  |                                                        |     继续执行     |





​    
