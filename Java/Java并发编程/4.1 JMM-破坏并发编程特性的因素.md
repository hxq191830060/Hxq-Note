**以下三个因素都可能会破坏并发编程的特性**

## 1. CPU的Cache

### 1.1 处理器Cache的使用

![指令重排序](p/写缓冲区.png)

每个CPU都有自己的Cache，线程要访问一个变量时，都会将变量从内存读入到Cache中，修改变量时也是在Cache中先修改

### 1.2 处理器缓冲区对并发编程的影响

可能会**破坏多线程程序的内存可见性**

## 2 指令重排序

### 2.1 什么是指令重排序

编译器和CPU为了优化程序性能，会对指令序列进行重排序

### 2.2 重排序的类型

![指令重排序](p/指令重排序.png)

* **编译器优化重排序**
  
  编译器在不改变单线程程序语义的前提下，进行指令重排序

* **指令级并行重排序**
  
  如果语句之间不存在数据依赖性，那么**处理器**可以改变语句对应的机器指令的执行顺序

* **内存系统重排序**
  
  **处理器**会使用缓存，对于没有数据依赖的读写操作，可以进行重排序

### 2.3 as-if-serial

**编译器或处理器在进行重排序时，要遵守 as-if-serial语义**——保护了单线程程序的语义和数据依赖关系，但是没有考虑多线程程序的语义和数据关系

所以指令重排序可以能会破坏多线程程序的语义

## 

## 3. CPU优化

### 3.1 什么是CPU优化

为了使处理器内部的运算单元能够尽量的被充分利用，处理器可能会对输入代码进行乱序执行处理

### 3.2 CPU优化多并发编程的影响

处理器优化会破坏**多线程程序的有序性**

## 4. 上下文切换

* CPU就这样不停的切换线程执行，CPU的切换可以发生在任何一条CPU指令执行结束后
* 高级语言的一条语句对应多条CPU指令

**上下文切换**会破坏程序的高级语言中操作的 **原子性**
