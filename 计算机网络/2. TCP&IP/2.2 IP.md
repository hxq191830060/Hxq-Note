# 1. IP介绍

## 1.1 IP组成

* IP(32位)——网络号和主机号

* **网络号相同的主机位于同一网段内**

* 主机号不能全为0，不能全为1
  
  * 主机号全为1——广播地址

## 1.2 IP早期分配

IP地址在早期分为**A，B，C，D四类**

![15](p/15.png)

## 1.3 广播

* 主机号全为1——广播地址——用于在同一个链路中相互连接的主机之间发送数据报
  
  例如网络号为192.168.0.0/24，广播地址为192.168.0.255

* 广播分为——**本地广播** 和 **直接广播**

### 1.3.1 本地广播

**本地广播**——在本网络内的广播

![16](p/16.png)

### 1.3.2 直接广播

**直接广播**——不同网络间的广播

![17](p/17.png)\

## 1.4 多播

* 多播用于将包发送给特定组内的所有主机

* 多播使用D类地址——前4位为"1110"，后28位为多播的组编号

## 1.5 现在的IP—CIDR

随着互联网的不断发展，IP的A，B，C，D分类方式不够用了，所以出现了——无类型域间路由(CIDR)

### 1.5.1 CIDR概念

采用任意长度分割IP地址的网络号和主机号，这种方式叫CIDR

### 1.5.2 CIDR的使用

要使用CIDR需要引入子网掩码

* 子网掩码32位
* IP中网络号的部分在子网掩码中为1，主机号部分为0
* IP&子网掩码=IP的网络号

## 1.6 私有IP

我们不要求为每台主机分配一个全局IP——因为这样的话，全局IP不够用

每台主机都处于一个网段中，我们在网段中为主机分配私有IP

* **私有IP**
  
  * A类(10/8)：10.0.0.0——10.255.255.255
  * B类(172.16/12)：172.16.0.0——172.16.255.255
  * C类(192.168/16)：192.168.0.0——192.168.255.255

* **全局IP**
  
  除了上述私有IP地址以外的IP为全局IP

* 全局IP必须保证唯一

* 私有IP只需要在所处网段中保证唯一即可，不同网段中可以有相同的私有IP

# 2. IP首部

![19](p/19.png)

- **TTL**
  
  Time To Live生存时间，指的是可以经过多少个路由器
  
  每经过一个路由器，TTL会减1，如果TTL为0，那么路由器会将其丢弃

- **Header Checksum**
  
  首部校验和——**只校验首部**，不校验数据，用来确保IP数据报的首部不被破坏

# 3. IP的使用

假设主机1(IP1,MAC1)要向主机2(IP2,MAC2)发送消息

**前提**

* 每台Linux主机的网络文件中都会配置自己的**CIDR地址**，**子网掩码**，**广播地址**，**GateWayIP地址**

* Linux要求**CIDR地址**与**GateWayIP地址**在**同一网段**下

* 要想成功通信，除了需要目标的IP地址外，还需要目标的**MAC地址**

**过程**

1. 主机1检查IP2是否与自己的IP1在同一个网段
2. 如果是——**通过广播地址发送ARP请求，获得主机2的MAC2，然后填充到包中，进行发送**
3. 如果不是——**通过GateWayIP地址和ARP获得GateWay的MAC地址，填充到包中，将包发送给GateWay**，至于后面，就看GateWay如何处理了

# 4. 路由Routing

Routing——将分组数据发送到最终目标地址的功能

![14](p/14.png)

* 主机A想要发送数据给主机B，中间要经过**许多路由器**

* **一跳(1 Hop)**
  
  利用数据链路层在一个区间内传输数据帧
  
  数据链路层使用MAC地址传输数据帧，一跳指是数据帧在**源MAC地址和目标MAC地址这一区间**内的传输（不经过路由器）

* 到达路由器后，会查询路由器的路由表——根据数据中的目标IP地址查找下一跳的方向

## 4.1 IP地址与路由控制

* IP地址的网络号部分用于进行路由控制

* 路由器的路由表中记录着**网络号**与**下一步应该要发送至的路由器的地址**的映射

* 发送IP包时，首先确定IP包首部中的 **目标IP地址**，然后在路由表中找到与该地址有相同网络号的记录，根据该记录将IP包转发给相应的下一个路由器

* 经过路由器时，IP首部不会变化（源IP地址，目标IP地址不会变），但是数据链路首部会重新填充（源MAC地址和目标MAC地址发生变化）

![18](p/18.png)

## 4.2 默认路由

默认路由——路由表中任何一个地址都能够与之匹配的记录

（如果目标IP地址在路由表中找不到匹配的记录，那么就匹配默认路由）

默认路由一般为 0.0.0.0/0 或 default

## 4.3 路由器

![1](p/5.png)

* 路由器是一个设备，由5个网卡或网口，每个连着一个子网(局域网)
* 每个网卡都是其连接着的子网的**GateWay**，该网卡的IP与其连接的子网的IP在同一网段下
